<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Global Market | Virtual Ventures</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="settings.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; background: #020617; color: white; font-family: 'Kanit', sans-serif; overflow: hidden; }
        
        .market-wrapper { 
            display: flex; flex-direction: column; height: 100vh; width: 100%; 
            padding-top: 80px; padding-bottom: 90px;
            background-image: linear-gradient(to bottom, rgba(2, 6, 23, 0.4), rgba(2, 6, 23, 0.85)), url('biz-bg.webp'); 
            background-size: cover; background-position: center; position: relative;
        }

        .global-ad-banner { width: 92%; height: 35px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 0.6rem; font-weight: 800; margin: 0 auto 10px; letter-spacing: 2px; }

        .nav-section { width: 92%; margin: 0 auto 10px; }
        .tabs-container { display: flex; background: rgba(15, 23, 42, 0.8); padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #64748b; font-weight: 700; font-size: 0.75rem; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: #fbbf24; color: #020617; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }

        .market-stats-box { width: 92%; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 15px; margin: 0 auto 12px; padding: 15px; display: flex; justify-content: space-around; backdrop-filter: blur(5px); }
        .stat-item { flex: 1; text-align: center; }
        .stat-val { display: block; font-weight: 900; font-size: 1.1rem; color: #fbbf24; }
        .stat-lbl { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; }

        #list-container { flex: 1; overflow-y: auto; padding: 0 4%; scrollbar-width: none; }
        #list-container::-webkit-scrollbar { display: none; }

        .asset-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(8px); border-radius: 18px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .info h4 { margin: 0; font-size: 0.85rem; color: #fbbf24; text-transform: uppercase; }
        .cat-tag { font-size: 0.55rem; color: #94a3b8; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; border: 0.5px solid rgba(255,255,255,0.1); }
        
        .price-now { text-align: right; }
        .price-val { font-weight: 900; color: #fff; font-size: 0.95rem; display: block; }
        .p-info { font-size: 0.6rem; font-weight: bold; }

        #tradeM { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(15px); }
        .modal-content { background: #0f172a; width: 92%; max-width: 380px; border-radius: 25px; padding: 20px; border: 1px solid #fbbf24; }
        
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .detail-box { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .detail-box label { display: block; font-size: 0.55rem; color: #64748b; margin-bottom: 2px; }
        .detail-box span { font-size: 0.75rem; font-weight: 700; color: #e2e8f0; }

        .input-area { background: #020617; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #1e293b; position: relative; }
        input { width: 100%; background: none; border: none; color: #fbbf24; font-size: 1.8rem; font-weight: 900; text-align: center; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #totalCost { text-align: center; font-size: 0.65rem; color: #64748b; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="market-wrapper">
        <div class="global-ad-banner">VIRTUAL STOCK EXCHANGE</div>
        <div class="nav-section">
            <div class="tabs-container">
                <button id="tab-stocks" class="tab-btn active" onclick="switchTab('stocks')">STOCKS</button>
                <button id="tab-crypto" class="tab-btn" onclick="switchTab('crypto')">CRYPTO</button>
                <button id="tab-estate" class="tab-btn" onclick="switchTab('estate')">ESTATE</button>
            </div>
        </div>
        <div class="market-stats-box">
            <div class="stat-item"><span id="topBalance" class="stat-val">0</span><span class="stat-lbl">CASH</span></div>
            <div class="stat-item" onclick="toggleFilter()" style="cursor:pointer"><span id="portVal" class="stat-val">0</span><span id="portLbl" class="stat-lbl">PORTFOLIO</span></div>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="tradeM">
        <div class="modal-content">
            <h3 id="mTitle" style="text-align:center; color:#fbbf24; margin-bottom:12px;"></h3>
            <canvas id="stockChart" height="110" style="margin-bottom:15px;"></canvas>
            <div class="details-grid" id="mDetails"></div>
            <div class="input-area">
                <input type="number" id="tradeQty" placeholder="0" oninput="calcTotal()">
                <div id="totalCost">Total (inc. 2% Fee): 0</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="handleTradeAction('BUY')" style="flex:1; padding:15px; border-radius:12px; background:#fbbf24; color:#020617; font-weight:900; border:none;">BUY</button>
                <button id="sellBtn" onclick="handleTradeAction('SELL')" style="flex:1; padding:15px; border-radius:12px; background:#1e293b; color:white; font-weight:900; border:1px solid #334155;">SELL</button>
            </div>
            <button onclick="closeModal()" style="width:100%; background:none; color:#64748b; margin-top:12px; font-size:0.7rem; font-weight:bold; border:none;">DISMISS</button>
        </div>
    </div>

<script>
    if(window.injectUI) window.injectUI();

    let currentTab = 'stocks';
    let filterMode = 'all';
    let masterData = { stocks: [], crypto: [], estate: [] };
    let selectedAsset = null;
    let chartInstance = null;

    const sectors = ["Banking", "FMCG", "IT Services", "Pharma", "Automobiles", "Green Energy", "Semiconductors", "Fintech", "Defense", "E-Commerce"];
    const stockNames = {
        "Banking": ["Global Bank", "Apex Finance", "Trust Capital", "Zenith Bank", "Nova Credit"],
        "FMCG": ["Pure Life", "Evergreen Co", "Daily Needs", "Nature Best", "Aura Goods"],
        "IT Services": ["Nexus Soft", "Matrix Systems", "Cloud Edge", "Logic Code", "Data Flow"],
        "Pharma": ["Bio Cure", "Life Gen", "Pulse Med", "Astra Lab", "Neuro Veda"],
        "Automobiles": ["Volt Motors", "Gear X", "Swift Drive", "Titan Auto", "Echo EV"],
        "Green Energy": ["Solaris", "Wind Power", "Hydro Gen", "Eco Flux", "Pure Watt"],
        "Semiconductors": ["Nano Chip", "Micro Logic", "Silicon X", "Core Tech", "Atomic AI"],
        "Fintech": ["Pay Pulse", "Neo Wallet", "Crypto Flow", "Smart Ledgr", "Safe Pay"],
        "Defense": ["Aero Guard", "Shield Tech", "Iron Works", "Orbit Def", "Delta Force"],
        "E-Commerce": ["Mega Cart", "Swift Ship", "Global Mall", "Urban Buy", "Direct X"]
    };

    function init() {
        const VERSION = "5.0"; 
        let saved = localStorage.getItem('vv_master_market');
        let savedVer = localStorage.getItem('vv_market_ver');
        let lastDailyUpdate = localStorage.getItem('vv_last_daily_update') || 0;
        let now = Date.now();

        if(!saved || savedVer !== VERSION) {
            masterData.stocks = [];
            sectors.forEach(s => {
                stockNames[s].forEach((name, i) => {
                    let p = Math.random() * 4000 + 150;
                    let baseMcapMult = Math.random() * 100 + 10; 
                    masterData.stocks.push({
                        id: 'stk_'+s+i,
                        name: name,
                        cat: s,
                        price: p, prev: p,
                        history: Array.from({length:15}, () => p + (Math.random()*40-20)),
                        mcapMult: baseMcapMult,
                        pe: (Math.random() * 25 + 12).toFixed(2),
                        div: (Math.random() * 2.5).toFixed(2) + "%"
                    });
                });
            });
            masterData.crypto = [{id:'c1', name:'VV-Coin', cat:'Utility', price:500, prev:500, history:Array.from({length:15},()=>500), mcapMult: 200, pe:'N/A', div:'0%'}];
            masterData.estate = [{id:'e1', name:'Virtual Penthouse', cat:'Luxury', price:250000, rent:4500}];
            localStorage.setItem('vv_master_market', JSON.stringify(masterData));
            localStorage.setItem('vv_market_ver', VERSION);
            localStorage.setItem('vv_last_daily_update', now);
        } else {
            masterData = JSON.parse(saved);
            if (now - lastDailyUpdate > 86400000) {
                masterData.stocks.forEach(s => {
                    s.pe = (Math.random() * 25 + 12).toFixed(2);
                    s.div = (Math.random() * 2.5).toFixed(2) + "%";
                });
                localStorage.setItem('vv_last_daily_update', now);
                localStorage.setItem('vv_master_market', JSON.stringify(masterData));
            }
        }
        switchTab('stocks');
    }

    // REAL-TIME DASHBOARD STYLE SYNC
    function syncBalance() {
        const balElement = document.getElementById('topBalance');
        if (balElement) {
            const currentBal = Number(localStorage.getItem('vv_balance')) || 0;
            balElement.innerText = window.formatBalance(currentBal);
        }
        const portValElement = document.getElementById('portVal');
        if (portValElement) {
            const p = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
            let count = Object.keys(p).filter(k => p[k].qty > 0).length;
            portValElement.innerText = count + " ASSETS";
        }
    }
    setInterval(syncBalance, 500);

    function render() {
        const port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let list = [...masterData[currentTab]];
        if(filterMode === 'owned') list = list.filter(x => port[x.id]?.qty > 0);
        
        let html = '';
        list.forEach(item => {
            let chg = item.prev ? ((item.price-item.prev)/item.prev*100).toFixed(2) : 0;
            let pData = port[item.id];
            let pInfo = (pData && pData.qty > 0) ? `<div style="font-size:0.55rem; color:#4ade80">Owned: ${pData.qty}</div>` : '';
            html += `<div class="asset-card" onclick="openTrade('${item.id}')">
                <div class="info"><h4>${item.name}</h4><span class="cat-tag">${item.cat}</span>${pInfo}</div>
                <div class="price-now"><span class="price-val">${window.formatBalance(item.price)}</span>
                <span class="p-info" style="color:${chg>=0?'#4ade80':'#ef4444'}">${chg>=0?'▲':'▼'} ${Math.abs(chg)}%</span></div></div>`;
        });
        document.getElementById('list-container').innerHTML = html;
        if(selectedAsset && document.getElementById('tradeM').style.display === 'flex') updateModalLive();
    }

    window.openTrade = (id) => {
        selectedAsset = masterData[currentTab].find(a => a.id === id);
        if(!selectedAsset) return;
        updateModalLive();
        document.getElementById('tradeM').style.display = 'flex';
    };

    function updateModalLive() {
        const p = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let currentMcap = ((selectedAsset.price * selectedAsset.mcapMult) / 100).toFixed(1) + "B";
        
        document.getElementById('mTitle').innerText = selectedAsset.name;
        document.getElementById('mDetails').innerHTML = `
            <div class="detail-box"><label>M-Cap (Live)</label><span>${currentMcap}</span></div>
            <div class="detail-box"><label>P/E Ratio (24h)</label><span>${selectedAsset.pe}</span></div>
            <div class="detail-box"><label>Div. Yield (24h)</label><span>${selectedAsset.div}</span></div>
            <div class="detail-box"><label>LTP</label><span style="color:#fbbf24">${window.formatBalance(selectedAsset.price)}</span></div>
            <div class="detail-box" style="grid-column: span 2; text-align:center"><label>Holding</label>
            <span style="color:#fbbf24">${(p[selectedAsset.id]?.qty || 0)} Shares | Avg: ${window.formatBalance(p[selectedAsset.id]?.avg || 0)}</span></div>`;
        updateChart(selectedAsset.history);
        calcTotal();
    }

    window.handleTradeAction = (type) => {
        let q = parseInt(document.getElementById('tradeQty').value) || 0;
        if(q <= 0) return;

        if (window.parent && typeof window.parent.showVideoAd === 'function') {
            window.parent.showVideoAd(() => executeTrade(type));
        } else {
            executeTrade(type);
        }
    };

    window.executeTrade = (type) => {
        let bal = Number(localStorage.getItem('vv_balance')) || 0;
        let port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let q = parseInt(document.getElementById('tradeQty').value) || 0;
        let cost = q * selectedAsset.price;
        let fee = cost * 0.02;

        if(type === 'BUY') {
            if(bal >= (cost + fee)) {
                localStorage.setItem('vv_balance', bal - (cost + fee));
                let oldQ = port[selectedAsset.id]?.qty || 0;
                let oldA = port[selectedAsset.id]?.avg || 0;
                port[selectedAsset.id] = { qty: oldQ + q, avg: ((oldA * oldQ) + (selectedAsset.price * q)) / (oldQ + q) };
            } else { alert("Insufficient Cash!"); return; }
        } else {
            if((port[selectedAsset.id]?.qty || 0) >= q) {
                localStorage.setItem('vv_balance', bal + (cost - fee));
                port[selectedAsset.id].qty -= q;
            } else { alert("Not enough shares!"); return; }
        }
        localStorage.setItem('vv_portfolio', JSON.stringify(port));
        syncBalance(); render(); closeModal();
    };

    function updateChart(h) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line', data: { labels: h.map((_,i)=>i), datasets: [{ data: h, borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, tension: 0.4 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, animation: { duration: 0 } }
        });
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        render();
    }

    function toggleFilter() {
        filterMode = filterMode === 'all' ? 'owned' : 'all';
        document.getElementById('portLbl').innerText = filterMode === 'owned' ? "OWNED ONLY" : "PORTFOLIO";
        render();
    }

    // Market Movement Every 5 Seconds
    setInterval(() => {
        masterData.stocks.forEach(item => {
            item.prev = item.price;
            item.price *= (1 + (Math.random()*0.02 - 0.01));
            item.history.push(item.price);
            if(item.history.length > 15) item.history.shift();
        });
        localStorage.setItem('vv_master_market', JSON.stringify(masterData));
        render();
    }, 5000);

    window.closeModal = () => { document.getElementById('tradeM').style.display = 'none'; selectedAsset = null; };
    window.calcTotal = () => {
        if(!selectedAsset) return;
        let q = document.getElementById('tradeQty').value || 0;
        document.getElementById('totalCost').innerText = "Total (inc. 2% Fee): " + window.formatBalance((q * selectedAsset.price) * 1.02);
    };

    init();
</script>
</body>
</html>