<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Market | Virtual Ventures</title>
    <script src="settings.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body, html { height: 100%; overflow: hidden; background: #020617; color: white; font-family: 'Kanit', sans-serif; }
        
        .market-wrapper { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100%; 
            padding-top: 75px; 
            padding-bottom: 95px;
            /* Background Fix: Ise business page se match kiya hai */
            background-image: linear-gradient(to bottom, rgba(2, 6, 23, 0.7), rgba(2, 6, 23, 0.9)), url('biz-bg.webp'); 
            background-size: cover; 
            background-position: center;
            position: relative; 
            z-index: 1;
        }

        .global-ad-banner { width: 92%; height: 50px; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 0.7rem; font-weight: 800; margin: 0 auto 10px; letter-spacing: 2px; }

        .nav-section { width: 92%; margin: 0 auto 10px; }
        .tabs-container { display: flex; background: rgba(15, 23, 42, 0.9); padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; color: #64748b; font-weight: 700; font-size: 0.75rem; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: #fbbf24; color: #020617; }

        .market-stats-box { width: 92%; background: rgba(15, 23, 42, 0.95); border: 1px solid #fbbf24; border-radius: 15px; margin: 0 auto 12px; padding: 15px; display: flex; justify-content: space-around; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .stat-item { flex: 1; text-align: center; cursor: pointer; }
        .stat-val { display: block; font-weight: 900; font-size: 1.1rem; color: #fbbf24; }
        .stat-lbl { font-size: 0.6rem; color: #94a3b8; }

        .tools-row { width: 92%; margin: 0 auto 10px; display: flex; justify-content: flex-end; }
        .sort-select { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(251, 191, 36, 0.4); color: #fbbf24; padding: 6px 12px; border-radius: 8px; font-size: 0.65rem; font-family: 'Kanit'; }

        /* Iframe Transparency Fix */
        #marketFrame { 
            flex: 1; 
            border: none; 
            width: 100%; 
            background: transparent !important;
        }
    </style>
</head>
<body>

    <div class="market-wrapper">
        <div class="global-ad-banner">LIVE TRADING FLOOR</div>
        
        <div class="nav-section">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="loadTab('stocks', this)">STOCKS</button>
                <button class="tab-btn" onclick="loadTab('crypto', this)">CRYPTO</button>
                <button class="tab-btn" onclick="loadTab('estate', this)">ESTATE</button>
            </div>
        </div>

        <div class="market-stats-box">
            <div class="stat-item">
                <span id="topBalance" class="stat-val">0</span>
                <span class="stat-lbl">CASH BALANCE</span>
            </div>
            <div style="width: 1px; height: 35px; background: rgba(251,191,36,0.2);"></div>
            <div class="stat-item" onclick="togglePortfolio()">
                <span id="portVal" class="stat-val">0</span>
                <span id="portLbl" class="stat-lbl">PORTFOLIO</span>
            </div>
        </div>

        <div class="tools-row">
            <select class="sort-select" id="sortOption" onchange="applySort()"></select>
        </div>

        <iframe id="marketFrame" src="market_stocks.html" allowtransparency="true" style="background:transparent;"></iframe>
    </div>

    <script>
        // Settings.js UI Injection
        if(window.injectUI) window.injectUI();

        let currentTab = 'stocks';
        let filterMode = 'all';

        const configs = {
            stocks: '<option value="price_desc">Price: High</option><option value="price_asc">Price: Low</option><option value="div_high">High Dividend</option>',
            crypto: '<option value="price_desc">Price: High</option><option value="price_asc">Price: Low</option>',
            estate: '<option value="price_desc">High Price</option><option value="rent_high">High Rent</option>'
        };

        function updateUI() {
            const coins = Number(localStorage.getItem('vv_balance')) || 0;
            document.getElementById('topBalance').innerText = window.formatBalance(coins);
            
            const port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
            let count = Object.keys(port).filter(k => port[k].qty > 0).length;
            document.getElementById('portVal').innerText = count > 0 ? count + " ASSETS" : "EMPTY";
            
            // Only update dropdown if it's empty
            if(!document.getElementById('sortOption').innerHTML) {
                document.getElementById('sortOption').innerHTML = configs[currentTab];
            }
        }

        function loadTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Frame change
            document.getElementById('marketFrame').src = `market_${tab}.html`;
            
            // Dropdown change
            document.getElementById('sortOption').innerHTML = configs[tab];
            
            filterMode = 'all';
            document.getElementById('portLbl').innerText = "PORTFOLIO";
            document.getElementById('portLbl').style.color = "#94a3b8";
            updateUI();
        }

        function togglePortfolio() {
            filterMode = (filterMode === 'all') ? 'owned' : 'all';
            document.getElementById('portLbl').innerText = filterMode === 'owned' ? "SHOWING OWNED" : "PORTFOLIO";
            document.getElementById('portLbl').style.color = filterMode === 'owned' ? "#fbbf24" : "#94a3b8";
            document.getElementById('marketFrame').contentWindow.postMessage({ type: 'filter', mode: filterMode }, '*');
        }

        function applySort() {
            const val = document.getElementById('sortOption').value;
            document.getElementById('marketFrame').contentWindow.postMessage({ type: 'sort', value: val }, '*');
        }

        window.addEventListener('message', (e) => { 
            if(e.data === 'updateStats') updateUI(); 
        });

        setInterval(updateUI, 2000);
        updateUI();
    </script>
</body>
</html>