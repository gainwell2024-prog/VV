<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Global Market | Virtual Ventures</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="settings.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; background: #020617; color: white; font-family: 'Kanit', sans-serif; overflow: hidden; }
        
        .market-wrapper { 
            display: flex; flex-direction: column; height: 100vh; width: 100%; 
            padding-top: 80px; padding-bottom: 90px;
            background-image: linear-gradient(to bottom, rgba(2, 6, 23, 0.4), rgba(2, 6, 23, 0.85)), url('biz-bg.webp'); 
            background-size: cover; background-position: center; position: relative;
        }

        .global-ad-banner { width: 92%; height: 35px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 0.6rem; font-weight: 800; margin: 0 auto 10px; letter-spacing: 2px; }

        .nav-section { width: 92%; margin: 0 auto 10px; }
        .tabs-container { display: flex; background: rgba(15, 23, 42, 0.8); padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #64748b; font-weight: 700; font-size: 0.75rem; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: #fbbf24; color: #020617; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }

        .market-stats-box { width: 92%; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(251, 191, 36, 0.5); border-radius: 15px; margin: 0 auto 12px; padding: 15px; display: flex; justify-content: space-around; backdrop-filter: blur(5px); }
        .stat-item { flex: 1; text-align: center; }
        .stat-val { display: block; font-weight: 900; font-size: 1.1rem; color: #fbbf24; }
        .stat-lbl { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; }

        /* Flash animation for cash update */
        @keyframes coinFlash {
            0% { color: #fbbf24; transform: scale(1); }
            50% { color: #4ade80; transform: scale(1.12); }
            100% { color: #fbbf24; transform: scale(1); }
        }
        .coin-update { animation: coinFlash 0.6s ease; }

        #list-container { flex: 1; overflow-y: auto; padding: 0 4%; scrollbar-width: none; }
        #list-container::-webkit-scrollbar { display: none; }

        .asset-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(8px); border-radius: 18px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .info h4 { margin: 0; font-size: 0.85rem; color: #fbbf24; text-transform: uppercase; }
        .cat-tag { font-size: 0.55rem; color: #94a3b8; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; border: 0.5px solid rgba(255,255,255,0.1); }
        
        .price-now { text-align: right; }
        .price-val { font-weight: 900; color: #fff; font-size: 0.95rem; display: block; }
        .p-info { font-size: 0.6rem; font-weight: bold; }

        #tradeM { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); display: none; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(15px); }
        .modal-content { background: #0f172a; width: 92%; max-width: 380px; border-radius: 25px; padding: 20px; border: 1px solid #fbbf24; }
        
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .detail-box { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .detail-box label { display: block; font-size: 0.55rem; color: #64748b; margin-bottom: 2px; }
        .detail-box span { font-size: 0.75rem; font-weight: 700; color: #e2e8f0; }

        .input-area { background: #020617; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #1e293b; position: relative; }
        input { width: 100%; background: none; border: none; color: #fbbf24; font-size: 1.8rem; font-weight: 900; text-align: center; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #totalCost { text-align: center; font-size: 0.65rem; color: #64748b; margin-top: 5px; }

        /* New for estate rent options */
        .rent-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .rent-option { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(251, 191, 36, 0.2); }
        .rent-option.selected { background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; }
        .rent-option label { display: block; font-size: 0.75rem; color: #fbbf24; }
        .rent-duration { margin-top: 10px; }
        .rent-duration input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155; color: #fbbf24; padding: 8px; border-radius: 8px; font-weight: 700; }
        .rent-total { text-align: center; font-size: 0.65rem; color: #64748b; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="market-wrapper">
        <div class="global-ad-banner">VIRTUAL STOCK EXCHANGE</div>
        <div class="nav-section">
            <div class="tabs-container">
                <button id="tab-stocks" class="tab-btn active" onclick="switchTab('stocks')">STOCKS</button>
                <button id="tab-crypto" class="tab-btn" onclick="switchTab('crypto')">CRYPTO</button>
                <button id="tab-estate" class="tab-btn" onclick="switchTab('estate')">ESTATE</button>
            </div>
        </div>
        <div class="market-stats-box">
            <div class="stat-item"><span id="topBalance" class="stat-val">0</span><span class="stat-lbl">CASH</span></div>
            <div class="stat-item" onclick="toggleFilter()" style="cursor:pointer"><span id="portVal" class="stat-val">0</span><span id="portLbl" class="stat-lbl">PORTFOLIO</span></div>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="tradeM">
        <div class="modal-content">
            <h3 id="mTitle" style="text-align:center; color:#fbbf24; margin-bottom:12px;"></h3>
            <canvas id="stockChart" height="110" style="margin-bottom:15px; display: none;"></canvas>
            <div class="details-grid" id="mDetails"></div>
            <div class="input-area" id="qtyInputArea">
                <input type="number" id="tradeQty" placeholder="0" oninput="calcTotal()">
                <div id="totalCost">Total (inc. Fee): 0</div>
            </div>
            <div class="rent-options" id="statusArea" style="display: none;">
                <div class="rent-option" onclick="selectStatus('vacant')">
                    <label>Vacant</label>
                </div>
                <div class="rent-option" onclick="selectStatus('rent')">
                    <label>For Rent</label>
                    <div class="rent-duration" id="rentDuration" style="display: none;">
                        <input type="number" id="rentHours" placeholder="Hours (max 168)" min="1" max="168" oninput="calcRentTotal()">
                        <div class="rent-total" id="rentTotalCost">Total Rent (inc. 1% Brokerage): 0</div>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="buyBtn" onclick="handleTradeAction('BUY')" style="flex:1; padding:15px; border-radius:12px; background:#fbbf24; color:#020617; font-weight:900; border:none;">BUY</button>
                <button id="sellBtn" onclick="handleTradeAction('SELL')" style="flex:1; padding:15px; border-radius:12px; background:#1e293b; color:white; font-weight:900; border:1px solid #334155;">SELL</button>
            </div>
            <button onclick="closeModal()" style="width:100%; background:none; color:#64748b; margin-top:12px; font-size:0.7rem; font-weight:bold; border:none;">DISMISS</button>
        </div>
    </div>

<script>
    if(window.injectUI) window.injectUI();

    let currentTab = 'stocks';
    let filterMode = 'all';
    let masterData = { stocks: [], crypto: [], estate: [] };
    let selectedAsset = null;
    let chartInstance = null;
    let selectedStatus = 'vacant';

    const sectors = ["Banking", "FMCG", "IT Services", "Pharma", "Automobiles", "Green Energy", "Semiconductors", "Fintech", "Defense", "E-Commerce"];
    const stockNames = {
        "Banking": ["Global Bank", "Apex Finance", "Trust Capital", "Zenith Bank", "Nova Credit"],
        "FMCG": ["Pure Life", "Evergreen Co", "Daily Needs", "Nature Best", "Aura Goods"],
        "IT Services": ["Nexus Soft", "Matrix Systems", "Cloud Edge", "Logic Code", "Data Flow"],
        "Pharma": ["Bio Cure", "Life Gen", "Pulse Med", "Astra Lab", "Neuro Veda"],
        "Automobiles": ["Volt Motors", "Gear X", "Swift Drive", "Titan Auto", "Echo EV"],
        "Green Energy": ["Solaris", "Wind Power", "Hydro Gen", "Eco Flux", "Pure Watt"],
        "Semiconductors": ["Nano Chip", "Micro Logic", "Silicon X", "Core Tech", "Atomic AI"],
        "Fintech": ["Pay Pulse", "Neo Wallet", "Crypto Flow", "Smart Ledgr", "Safe Pay"],
        "Defense": ["Aero Guard", "Shield Tech", "Iron Works", "Orbit Def", "Delta Force"],
        "E-Commerce": ["Mega Cart", "Swift Ship", "Global Mall", "Urban Buy", "Direct X"]
    };

    const estateData = [
        {id: 'e1', name: 'Skyline Business Hub', location: 'Neo Mumbai Central', cat: 'Business Center', price: 500000, rent: 5000},
        {id: 'e2', name: 'Harbor View Hotel', location: 'San Francisco Bay', cat: 'Hotel', price: 750000, rent: 7500},
        {id: 'e3', name: 'Metro Plaza Office Hub', location: 'London City', cat: 'Business Center', price: 600000, rent: 6000},
        {id: 'e4', name: 'Sunrise Resort Hotel', location: 'Dubai Marina', cat: 'Hotel', price: 900000, rent: 9000},
        {id: 'e5', name: 'Riverfront Corporate Park', location: 'Tokyo Waterfront', cat: 'Business Center', price: 550000, rent: 5500},
        {id: 'e6', name: 'Golden Sands Luxury Hotel', location: 'Paris Seine', cat: 'Hotel', price: 800000, rent: 8000},
        {id: 'e7', name: 'Central Avenue Commerce Center', location: 'Sydney CBD', cat: 'Business Center', price: 650000, rent: 6500},
        {id: 'e8', name: 'Ocean Breeze Hotel', location: 'Mumbai Marine Drive', cat: 'Hotel', price: 700000, rent: 7000},
        {id: 'e9', name: 'Elite Plaza Business Hub', location: 'Singapore Raffles', cat: 'Business Center', price: 850000, rent: 8500},
        {id: 'e10', name: 'Imperial Heights Hotel', location: 'Berlin Mitte', cat: 'Hotel', price: 950000, rent: 9500},
        {id: 'e11', name: 'Valley Tech Center', location: 'Bangalore IT Corridor', cat: 'Business Center', price: 450000, rent: 4500},
        {id: 'e12', name: 'Paradise Island Resort', location: 'Miami Beach', cat: 'Hotel', price: 1000000, rent: 10000},
        {id: 'e13', name: 'Urban Core Office Complex', location: 'Shanghai Pudong', cat: 'Business Center', price: 700000, rent: 7000},
        {id: 'e14', name: 'Royal View Hotel', location: 'Rome Colosseum', cat: 'Hotel', price: 850000, rent: 8500},
        {id: 'e15', name: 'Innovation Park Business Center', location: 'Seoul Gangnam', cat: 'Business Center', price: 600000, rent: 6000},
        {id: 'e16', name: 'Crystal Lake Hotel', location: 'Toronto Downtown', cat: 'Hotel', price: 750000, rent: 7500},
        {id: 'e17', name: 'Downtown Elite Hub', location: 'Hong Kong Central', cat: 'Business Center', price: 900000, rent: 9000},
        {id: 'e18', name: 'Eternal City Resort', location: 'Istanbul Bosphorus', cat: 'Hotel', price: 800000, rent: 8000},
        {id: 'e19', name: 'Tech Valley Center', location: 'Boston Seaport', cat: 'Business Center', price: 550000, rent: 5500},
        {id: 'e20', name: 'Majestic Heights Hotel', location: 'Cape Town Waterfront', cat: 'Hotel', price: 650000, rent: 6500},
        {id: 'e21', name: 'Prime District Office', location: 'Mexico City Reforma', cat: 'Business Center', price: 500000, rent: 5000},
        {id: 'e22', name: 'Sunset Boulevard Hotel', location: 'Los Angeles Hollywood', cat: 'Hotel', price: 950000, rent: 9500},
        {id: 'e23', name: 'Global Trade Center', location: 'Amsterdam Zuidas', cat: 'Business Center', price: 700000, rent: 7000},
        {id: 'e24', name: 'Azure Bay Resort', location: 'Barcelona Port Vell', cat: 'Hotel', price: 850000, rent: 8500},
        {id: 'e25', name: 'Empire State Commerce', location: 'Chicago Loop', cat: 'Business Center', price: 750000, rent: 7500}
    ];

    function init() {
        const VERSION = "5.0"; 
        let saved = localStorage.getItem('vv_master_market');
        let savedVer = localStorage.getItem('vv_market_ver');
        let lastDailyUpdate = localStorage.getItem('vv_last_daily_update') || 0;
        let now = Date.now();

        if(!saved || savedVer !== VERSION) {
            masterData.stocks = [];
            sectors.forEach(s => {
                stockNames[s].forEach((name, i) => {
                    let p = Math.random() * 4000 + 150;
                    let baseMcapMult = Math.random() * 100 + 10; 
                    masterData.stocks.push({
                        id: 'stk_'+s+i,
                        name: name,
                        cat: s,
                        price: p, prev: p,
                        history: Array.from({length:15}, () => p + (Math.random()*40-20)),
                        mcapMult: baseMcapMult,
                        pe: (Math.random() * 25 + 12).toFixed(2),
                        div: (Math.random() * 2.5).toFixed(2) + "%"
                    });
                });
            });
            masterData.crypto = [{id:'c1', name:'VV-Coin', cat:'Utility', price:500, prev:500, history:Array.from({length:15},()=>500), mcapMult: 200, pe:'N/A', div:'0%'}];
            masterData.estate = estateData.map((e, i) => ({...e, id: 'e' + (i + 1), prev: e.price, history: Array.from({length:15}, () => e.price + (Math.random()*40-20))}));
            localStorage.setItem('vv_master_market', JSON.stringify(masterData));
            localStorage.setItem('vv_market_ver', VERSION);
            localStorage.setItem('vv_last_daily_update', now);
        } else {
            masterData = JSON.parse(saved);
            if (now - lastDailyUpdate > 86400000) {
                masterData.stocks.forEach(s => {
                    s.pe = (Math.random() * 25 + 12).toFixed(2);
                    s.div = (Math.random() * 2.5).toFixed(2) + "%";
                });
                localStorage.setItem('vv_last_daily_update', now);
                localStorage.setItem('vv_master_market', JSON.stringify(masterData));
            }
        }
        switchTab('stocks');
    }

    // REAL-TIME CASH UPDATE (Fixed for idle)
    let lastKnownBalance = Number(localStorage.getItem('vv_balance')) || 0;

    function updateCashLive() {
        const balElement = document.getElementById('topBalance');
        if (!balElement) return;

        // Force sync finances
        if (window.processFinances) window.processFinances();

        const currentBal = Number(localStorage.getItem('vv_balance')) || 0;
        const oldText = balElement.innerText;
        const newFormatted = window.formatBalance(currentBal);
        balElement.innerText = newFormatted;

        if (oldText !== newFormatted) {
            balElement.classList.add('coin-update');
            setTimeout(() => balElement.classList.remove('coin-update'), 600);
        }

        lastKnownBalance = currentBal;

        const portValElement = document.getElementById('portVal');
        if (portValElement) {
            const p = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
            let count = Object.keys(p).filter(k => p[k].qty > 0).length;
            portValElement.innerText = count + " ASSETS";
        }
    }

    setInterval(updateCashLive, 1000);
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            updateCashLive(); // Immediate sync on tab focus
        }
    });
    updateCashLive(); // Initial

    function render() {
        const port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let list = [...masterData[currentTab]];
        if(filterMode === 'owned') list = list.filter(x => port[x.id]?.qty > 0);
        
        let html = '';
        list.forEach(item => {
            let chg = item.prev ? ((item.price-item.prev)/item.prev*100).toFixed(2) : 0;
            let pData = port[item.id];
            let pInfo = (pData && pData.qty > 0) ? `<div style="font-size:0.55rem; color:#4ade80">Owned: ${pData.qty}</div>` : '';
            html += `<div class="asset-card" onclick="openTrade('${item.id}')">
                <div class="info"><h4>${item.name}</h4><span class="cat-tag">${currentTab === 'estate' ? item.location : item.cat}</span>${pInfo}</div>
                <div class="price-now"><span class="price-val">${window.formatBalance(item.price)}</span>
                <span class="p-info" style="color:${chg>=0?'#4ade80':'#ef4444'}">${chg>=0?'▲':'▼'} ${Math.abs(chg)}%</span></div></div>`;
        });
        document.getElementById('list-container').innerHTML = html;
        if(selectedAsset && document.getElementById('tradeM').style.display === 'flex') updateModalLive();
    }

    window.openTrade = (id) => {
        selectedAsset = masterData[currentTab].find(a => a.id === id);
        if(!selectedAsset) return;
        selectedStatus = 'vacant';
        document.getElementById('tradeM').style.display = 'flex';
        updateModalLive();
    };

    function updateModalLive() {
        const p = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        const isEstate = currentTab === 'estate';
        document.getElementById('mTitle').innerText = selectedAsset.name;
        document.getElementById('stockChart').style.display = isEstate ? 'none' : 'block';
        document.getElementById('qtyInputArea').style.display = isEstate ? 'none' : 'block';
        document.getElementById('statusArea').style.display = isEstate && p[selectedAsset.id]?.qty > 0 ? 'block' : 'none';
        document.getElementById('buyBtn').style.display = p[selectedAsset.id]?.qty > 0 ? 'none' : 'block';
        document.getElementById('sellBtn').style.display = p[selectedAsset.id]?.qty > 0 ? 'block' : 'block';

        document.getElementById('mDetails').innerHTML = isEstate ? `
            <div class="detail-box"><label>Location</label><span>${selectedAsset.location}</span></div>
            <div class="detail-box"><label>Price</label><span style="color:#fbbf24">${window.formatBalance(selectedAsset.price)}</span></div>
            <div class="detail-box"><label>Rent /hr</label><span>${window.formatBalance(selectedAsset.rent)}</span></div>
            <div class="detail-box"><label>Status</label><span>${p[selectedAsset.id]?.status || 'vacant'}</span></div>
            <div class="detail-box" style="grid-column: span 2; text-align:center"><label>Holding</label>
            <span style="color:#fbbf24">${(p[selectedAsset.id]?.qty || 0)} Units</span></div>` : `
            <div class="detail-box"><label>M-Cap (Live)</label><span>${((selectedAsset.price * (selectedAsset.mcapMult || 100)) / 100).toFixed(1) + "B"}</span></div>
            <div class="detail-box"><label>P/E Ratio (24h)</label><span>${selectedAsset.pe || 'N/A'}</span></div>
            <div class="detail-box"><label>Div. Yield (24h)</label><span>${selectedAsset.div || '0%'}</span></div>
            <div class="detail-box"><label>LTP</label><span style="color:#fbbf24">${window.formatBalance(selectedAsset.price)}</span></div>
            <div class="detail-box" style="grid-column: span 2; text-align:center"><label>Holding</label>
            <span style="color:#fbbf24">${(p[selectedAsset.id]?.qty || 0)} Shares | Avg: ${window.formatBalance(p[selectedAsset.id]?.avg || 0)}</span></div>`;
        if (!isEstate) updateChart(selectedAsset.history);
        calcTotal();
    }

    window.selectStatus = (status) => {
        selectedStatus = status;
        document.querySelectorAll('.rent-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector(`[onclick="selectStatus('${status}')"]`).classList.add('selected');
        document.getElementById('rentDuration').style.display = status === 'rent' ? 'block' : 'none';
        if (status === 'rent') calcRentTotal();
    };

    window.calcRentTotal = () => {
        if (!selectedAsset) return;
        let hours = parseInt(document.getElementById('rentHours').value) || 0;
        if (hours > 168) hours = 168;
        let totalRent = hours * selectedAsset.rent;
        let brokerage = totalRent * 0.01;
        document.getElementById('rentTotalCost').innerText = "Total Rent (inc. 1% Brokerage): " + window.formatBalance(totalRent - brokerage);
    };

    window.handleTradeAction = (type) => {
        if (currentTab === 'estate') {
            if (type === 'BUY') {
                let bal = Number(localStorage.getItem('vv_balance')) || 0;
                let cost = selectedAsset.price;
                let fee = cost * 0.10; // 10% stamp duty
                if (bal >= (cost + fee)) {
                    localStorage.setItem('vv_balance', bal - (cost + fee));
                    let port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
                    port[selectedAsset.id] = { qty: 1, avg: selectedAsset.price, status: selectedStatus };
                    localStorage.setItem('vv_portfolio', JSON.stringify(port));
                    alert("Property purchased! Stamp Duty 10% applied.");
                    updateCashLive();
                    render();
                    closeModal();
                } else {
                    alert("Insufficient Cash!");
                }
                return;
            }
            if (type === 'SELL') {
                let port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
                if (port[selectedAsset.id]?.qty > 0) {
                    let bal = Number(localStorage.getItem('vv_balance')) || 0;
                    let cost = selectedAsset.price;
                    let fee = cost * 0.02; // Sell fee 2%
                    localStorage.setItem('vv_balance', bal + (cost - fee));
                    delete port[selectedAsset.id];
                    localStorage.setItem('vv_portfolio', JSON.stringify(port));
                    alert("Property sold!");
                    updateCashLive();
                    render();
                    closeModal();
                }
                return;
            }
        }

        // Normal stock/crypto trade
        let q = parseInt(document.getElementById('tradeQty').value) || 0;
        if(q <= 0) return;

        if (window.parent && typeof window.parent.showVideoAd === 'function') {
            window.parent.showVideoAd(() => executeTrade(type, q));
        } else {
            executeTrade(type, q);
        }
    };

    window.executeTrade = (type, q) => {
        let bal = Number(localStorage.getItem('vv_balance')) || 0;
        let port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let cost = q * selectedAsset.price;
        let fee = cost * 0.02;

        if(type === 'BUY') {
            if(bal >= (cost + fee)) {
                localStorage.setItem('vv_balance', bal - (cost + fee));
                let oldQ = port[selectedAsset.id]?.qty || 0;
                let oldA = port[selectedAsset.id]?.avg || 0;
                port[selectedAsset.id] = { qty: oldQ + q, avg: ((oldA * oldQ) + (selectedAsset.price * q)) / (oldQ + q) };
            } else { alert("Insufficient Cash!"); return; }
        } else {
            if((port[selectedAsset.id]?.qty || 0) >= q) {
                localStorage.setItem('vv_balance', bal + (cost - fee));
                port[selectedAsset.id].qty -= q;
            } else { alert("Not enough shares!"); return; }
        }
        localStorage.setItem('vv_portfolio', JSON.stringify(port));
        updateCashLive();
        render();
        closeModal();
    };

    function updateChart(h) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line', data: { labels: h.map((_,i)=>i), datasets: [{ data: h, borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, tension: 0.4 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, animation: { duration: 0 } }
        });
    }

    function switchTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        if (t === 'crypto') {
            document.getElementById('list-container').innerHTML = '<div style="text-align:center; font-size:1.5rem; color:#fbbf24; margin-top:50%;">Coming Soon</div>';
        } else {
            render();
        }
    }

    function toggleFilter() {
        filterMode = filterMode === 'all' ? 'owned' : 'all';
        document.getElementById('portLbl').innerText = filterMode === 'owned' ? "OWNED ONLY" : "PORTFOLIO";
        render();
    }

    // Market Movement Every 5 Seconds
    setInterval(() => {
        masterData.stocks.forEach(item => {
            item.prev = item.price;
            item.price *= (1 + (Math.random()*0.02 - 0.01));
            item.history.push(item.price);
            if(item.history.length > 15) item.history.shift();
        });
        localStorage.setItem('vv_master_market', JSON.stringify(masterData));
        render();
    }, 5000);

    window.closeModal = () => { document.getElementById('tradeM').style.display = 'none'; selectedAsset = null; };
    window.calcTotal = () => {
        if(!selectedAsset) return;
        let q = document.getElementById('tradeQty').value || 0;
        document.getElementById('totalCost').innerText = "Total (inc. 2% Fee): " + window.formatBalance((q * selectedAsset.price) * 1.02);
    };

    init();
</script>
</body>
</html>