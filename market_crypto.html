<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="settings.js"></script>
    <style>
        body { background: transparent; color: white; font-family: 'Kanit', sans-serif; padding: 10px; overflow-x: hidden; scrollbar-width: none; }
        .asset-card { background: rgba(15, 23, 42, 0.7); border-radius: 18px; padding: 15px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .info h4 { margin: 0; font-size: 0.9rem; color: #fbbf24; }
        .info span { font-size: 0.65rem; color: #94a3b8; }
        .price-now { font-weight: 900; color: #fff; font-size: 0.95rem; text-align: right; }
        
        #m { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
        .mc { background: #0f172a; width: 100%; max-width: 360px; border-radius: 25px; padding: 20px; border: 1px solid #fbbf24; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 15px; margin: 10px 0; border: 1px solid #1e293b; }
        .it span { display: block; font-size: 0.55rem; color: #64748b; }
        .it b { font-size: 0.75rem; }
    </style>
</head>
<body>
    <div id="list"></div>

    <div id="m"><div class="mc">
        <h3 id="mt" style="text-align:center; color:#fbbf24; margin-bottom:10px;"></h3>
        <canvas id="ch" height="120"></canvas>
        <div class="grid" id="gd"></div>
        <input type="number" id="qty" style="width:100%; background:#020617; border:1px solid #334155; padding:12px; border-radius:12px; color:white; text-align:center; font-weight:900;" placeholder="0.00" oninput="upd()">
        <div id="tot" style="text-align:center; color:#fbbf24; font-weight:900; margin:10px 0;">0</div>
        <div style="font-size:0.55rem; color:#ef4444; text-align:center; margin-bottom:10px;">EXCHANGE FEE: 2% | PROFIT TAX: 15%</div>
        <div style="display:flex; gap:10px;">
            <button onclick="trade('BUY')" style="flex:1; padding:15px; background:#fbbf24; border:none; border-radius:12px; font-weight:900;">BUY</button>
            <button onclick="trade('SELL')" style="flex:1; padding:15px; background:#1e293b; border:1px solid #334155; color:white; border-radius:12px; font-weight:900;">SELL</button>
        </div>
        <button onclick="closeM()" style="width:100%; background:none; border:none; color:#64748b; margin-top:15px; font-size:0.8rem;">CLOSE</button>
    </div></div>

<script>
    let assets = []; let sel = null; let chart = null; let filterMode = 'all';
    const cryptos = ["Bitcoin","Ethereum","Solana","Cardano","Polkadot","Ripple","Litecoin","Chainlink","Avalanche","Polygon","Cosmos","Uniswap","Stellar","Monero","Algorand","Vechain","Theta","Filecoin","Tron","Near"];
    const algos = ["SHA-256", "Ethash", "Proof of Stake", "Proof of History", "Ouroboros"];

    function init() {
        let saved = localStorage.getItem('vv_crypto_data');
        if(saved) assets = JSON.parse(saved);
        else {
            for(let i=0; i<25; i++) {
                assets.push({
                    id: 'c'+i, name: cryptos[i%cryptos.length] + (i>19?"-V2":""),
                    price: i==0 ? 64000 : (i<5 ? Math.random()*2000+100 : Math.random()*5),
                    vol: (Math.random()*80).toFixed(1) + "B",
                    supply: (Math.random()*500).toFixed(0) + "M",
                    algo: algos[i%algos.length],
                    history: [50, 55, 48, 60, 58]
                });
            }
            localStorage.setItem('vv_crypto_data', JSON.stringify(assets));
        }
        render();
    }

    function render() {
        const port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let display = [...assets];
        if(filterMode === 'owned') display = display.filter(a => port[a.id]?.qty > 0);
        
        let html = '';
        display.forEach(a => {
            let p = port[a.id] || { qty: 0, avg: 0 };
            // Portfolio logic: show average buy price
            let sub = filterMode === 'owned' ? `Avg Buy: ${window.formatBalance(p.avg)}` : `Vol: ${a.vol} | ${a.algo}`;
            html += `<div class="asset-card" onclick="openM('${a.id}')">
                <div class="info"><h4>${a.name}</h4><span>${sub}</span></div>
                <div class="price-now">${a.price.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
            </div>`;
        });
        document.getElementById('list').innerHTML = html;
    }

    window.openM = (id) => {
        sel = assets.find(a => a.id === id);
        const port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        document.getElementById('mt').innerText = sel.name;
        document.getElementById('gd').innerHTML = `<div class="it"><span>24h Vol</span><b>${sel.vol}</b></div><div class="it"><span>Supply</span><b>${sel.supply}</b></div><div class="it"><span>Owned</span><b>${(port[id]?.qty || 0).toFixed(4)}</b></div><div class="it"><span>Algo</span><b>${sel.algo}</b></div>`;
        document.getElementById('m').style.display = 'flex';
        initChart(sel.history);
    };

    function trade(type) {
        let q = parseFloat(document.getElementById('qty').value) || 0;
        if(q <= 0) return;
        if(parent.window.showVideoAd) parent.window.showVideoAd(() => processTrade(type, q));
        else processTrade(type, q);
    }

    function processTrade(type, q) {
        let bal = Number(localStorage.getItem('vv_balance')) || 0;
        let port = JSON.parse(localStorage.getItem('vv_portfolio')) || {};
        let cost = q * sel.price; let fee = cost * 0.02;

        if(type === 'BUY') {
            if(bal >= (cost+fee)) {
                localStorage.setItem('vv_balance', bal - (cost+fee));
                let oldQ = port[sel.id]?.qty || 0;
                let oldA = port[sel.id]?.avg || 0;
                port[sel.id] = { qty: oldQ + q, avg: ((oldA * oldQ) + (sel.price * q)) / (oldQ + q) };
            }
        } else {
            if((port[sel.id]?.qty || 0) >= q) {
                let profit = (sel.price - port[sel.id].avg) * q;
                let tax = profit > 0 ? profit * 0.15 : 0;
                localStorage.setItem('vv_balance', bal + (cost - fee - tax));
                port[sel.id].qty -= q;
            }
        }
        localStorage.setItem('vv_portfolio', JSON.stringify(port));
        closeM(); render(); parent.postMessage('updateStats', '*');
    }

    window.addEventListener('message', (e) => {
        if(e.data.type === 'filter') { filterMode = e.data.mode; render(); }
        if(e.data.type === 'sort') { 
            if(e.data.value === 'price_desc') assets.sort((a,b)=>b.price-a.price);
            if(e.data.value === 'vol_high') assets.sort((a,b)=>parseFloat(b.vol)-parseFloat(a.vol));
            render();
        }
    });

    function initChart(data) {
        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('ch'), {
            type: 'line',
            data: { labels: data.map((_,i)=>i), datasets: [{ data: data, borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, tension: 0.4 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
    }
    window.closeM = () => document.getElementById('m').style.display='none';
    window.upd = () => document.getElementById('tot').innerText = (parseFloat(document.getElementById('qty').value||0)*sel.price).toLocaleString();
    init();
</script>
</body>
</html>